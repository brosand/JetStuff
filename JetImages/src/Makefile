#
# Examples Makefile.
#
#                  M. Kirsanov 07.04.2006
#                     Modified 18.11.2006
#                     26.03.2008 CLHEP dependency removed

SHELL = /bin/sh

-include config.mk
PYTHIA8LOCATION=
ifeq (x$(PYTHIA8LOCATION),x)
 # PYTHI8LOCATION=/afs/slac/g/atlas/c/sw/lcg/external/MCGenerators/pythia8/150/i686-slc5-gcc43-opt
 PYTHI8LOCATION=/u/at/estrauss/afs/WTagger/Pythia8176/share
endif
#PYTHIA8LOCATION=/afs/slac/g/atlas/c/sw/lcg/external/MCGenerators/pythia8/150/i686-slc5-gcc43-opt
PYTHIA8LOCATION=/u/at/estrauss/afs/WTagger/Pythia8176/
HEPMCLOCATION=/u/eb/joshgc/mynfs/HepMC/install
#-include $(PYTHIA8LOCATION)/config.mk

ifeq (x$(FASTJETLOCATION),x)
 FASTJETLOCATION=/u/eb/joshgc/mynfs/FastJet/fastjet-install/
endif

ROOTINC=-I`root-config --incdir`
ROOTLIBS= `root-config --glibs`  -lMLP -lTreePlayer
TMVAINC=-I$(ROOTSYS)/tmva/inc/
TMVALIB=-L$(ROOTSYS)/lib -lTMVA

WTAGLOCATION=/u/at/estrauss/afs/WTagger/MVATagger/wtag-1.00/
FASTPRUNELOCATION=/u/at/estrauss/afs/WTagger/MVATagger/FastPrune-0.4.3
FASTPRUNEINC=-I $(FASTPRUNELOCATION)/include
FASTPRUNELIB=-L $(FASTPRUNELOCATION)/lib -lFastPrunePlugin 

ALL_INC=-I../include                                            \
-I$(PYTHIA8LOCATION)/include                                    \
-I$(PYTHIA8LOCATION)/examples                                   \
-I$(HEPMCLOCATION)/include 					                    \
-I $(WTAGLOCATION)/include/                                     \
-I $(BOOSTINCDIR) 							                    \
`$(FASTJETLOCATION)/bin/fastjet-config --cxxflags --plugins` 	\
-I/u/eb/joshgc/mynfs/FastJetcontrib/fjcontrib-1.002/			

ALL_LINK= -L$(BOOSTLIBLOCATION)             \
-L$(HEPMCLOCATION)/lib 						\
-L$(PYTHIA8LOCATION)/lib/archive            \
-L$(PYTHIA8LOCATION)/lib                    \
-lpythia8 -llhapdfdummy -lHepMC             \
-lhepmcinterface $(LIBGZIP)                 \
-L$(FASTJETLOCATION)/lib                    \
`$(FASTJETLOCATION)/bin/fastjet-config --libs --plugins |  sed 's/ -lm / /g'` \
-lboost_program_options                     \
-L$(FASTJETLOCATION)/lib                    \
`root-config --glibs`                       \
$(TMVALIB)                                  \
$(FASTPRUNELIB)                             \
-lrt ##this is necessary for ns timing (only tested at SLAC)

# Libraries to include if GZIP support is enabled
ifeq (x$(ENABLEGZIP),xyes)
LIBGZIP=-L$(BOOSTLIBLOCATION) -lboost_iostreams -L$(ZLIBLOCATION) -lz
endif

baseflags=-O2 -m32 
CXXFLAGS=$(baseflags)

MAINS   = pythiaJets hepmcJets
SOURCES = $(shell ls *.cxx | grep -vE '(Evgen|pythiaJets|hepmcJets)')
OBJECTS = $(SOURCES:.cxx=.so) wtag.so

.PHONY: clean debug all

all: $(MAINS)

%.d: %.cxx
	$(CXX) $(CXXFLAGS) -MM -MT '$(patsubst %.cxx,%.o,$<)' $< -MF $@  \
	$(ALL_INC)

# Note: $(CXXFLAGS) is after Fastjet flags as Fastjet includes
#       optimisation/debug flags which may be unwanted (e.g. -g -O2)
wtag.so : $(WTAGLOCATION)/src/wtag.cc $(WTAGLOCATION)/include/wtag.h
	$(CXX) -o $@ -c $< \
	-I $(WTAGLOCATION)/include/  \
	`$(FASTJETLOCATION)/bin/fastjet-config --cxxflags --plugins` \
	$(ROOTINC) $(TMVAINC) $(FASTPRUNEINC) \
	$(CXXFLAGS) -fPIC -shared

#$(MAINS): %.so : %.cxx %.d JetAnalysis.so
$(patsubst %, %.so, $(MAINS)): %.so : %.cxx %.d JetAnalysis.so
	$(CXX) -o $@ -c $< 					    \
	$(CXXFLAGS) -Wno-shadow -fPIC -shared   \
    $(ALL_INC)                              \

%.so: %.cxx ../include/%.h %.d 
	@echo Using Autogenerated Rule
	$(CXX) -o $@ -c $< 												\
	$(CXXFLAGS) -Wno-shadow -fPIC -shared							\
	$(ALL_INC)

$(MAINS): % : %.so $(PYTHIA8LOCATION)/lib/archive/libpythia8.a $(OBJECTS)
	$(CXX) $< $(OBJECTS) -o $@  \
	$(CXXFLAGS) -Wno-shadow   	\
	$(ALL_LINK)
	cp $@ $@.exe


#this is the herwig stuff.
#Evgen.so : Evgen.cc Evgen.h 
#	$(CXX) -shared -fPIC -I/u/eb/joshgc/mynfs/Herwig/install-dir/include \
#	-I/u/eb/joshgc/mynfs/ThePEG/install-dir/include \
#	-I $(HEPMCLOCATION)/include \
#    /afs/slac/g/atlas/c/sw/lcg/external/HepMC/2.03.11/i686-slc5-gcc43-opt/lib/libHepMC.so \
#	-Wl,-export-dynamic \
#	$(CXXFLAGS) $< -o $@  
#	cp $@ /u/eb/joshgc/mynfs/Herwig/install-dir/lib/Herwig++/

debug:
	@#echo PYTHIA8LOCATION IS HERE: $(PYTHIA8LOCATION)
	@#$(FASTJETLOCATION)/bin/fastjet-config --cxxflags --plugins
	@#$(FASTJETLOCATION)/bin/fastjet-config --libs --plugins
	@echo Sources are $(SOURCES)
	@echo Objects are $(OBJECTS)
	@echo Mains   are $(MAINS)
	@echo $(patsubst %, %.so, $(MAINS)): %.so 


# Clean up: remove executables and outdated files.
clean:
	rm -rf bin/
	rm -rf *.exe
	rm -rf *.o
	rm -rf *.so
	rm -f *~; rm -f \#*; rm -f core*
